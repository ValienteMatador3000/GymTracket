<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Gym Tracker — Con Sesiones</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="icon" href="icon-192.png">

  <style>
    :root{
      --bg: #ffffff;
      --card: #fff;
      --muted: #777;
      --border: #e6e6e6;
      --accent: #111;
      --icon: #666;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      color: var(--accent);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    header {
      padding:16px;
      text-align:center;
      border-bottom:1px solid var(--border);
      background:#fff;
    }
    header h1 { margin:0; font-size:18px; font-weight:600; }

    main { padding:12px; padding-bottom:88px; max-width:760px; margin:0 auto; }

    /* Sections */
    section { display:none; padding-top:10px; }
    section.active { display:block; }

    h2 { margin:8px 0 12px 0; font-size:16px; text-align:center; font-weight:600; }

    /* Cards */
    .card {
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin:8px auto;
      max-width:720px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .left { flex:1; text-align:left; }
    .card .left strong { display:block; font-size:15px; }
    .card .left .muted { color:var(--muted); font-size:13px; margin-top:6px; }

    /* Buttons / icons */
    .icon-btn {
      background:none;
      border:none;
      padding:8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:var(--icon);
      border-radius:8px;
    }
    .icon-btn:hover { background:#f6f6f6; }
    .fab {
      position: fixed;
      right: 18px;
      bottom: 86px;
      width:54px; height:54px;
      border-radius:50%;
      border:none;
      background:var(--accent);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      cursor:pointer;
      font-size:22px;
    }

    /* Footer nav minimal */
    nav {
      position:fixed;
      left:0; right:0; bottom:0;
      display:flex;
      background:#fff;
      border-top:1px solid var(--border);
      z-index:100;
      height:64px;
      align-items:center;
      justify-content:space-around;
    }
    nav button {
      background:none; border:none; padding:8px 10px;
      display:flex; flex-direction:column; gap:2px; align-items:center; color:var(--icon); cursor:pointer;
      font-size:12px;
    }
    nav button.active { color:var(--accent); font-weight:600; }

    /* inputs */
    .input { padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#fff; width:100%; }
    label.muted { color:var(--muted); font-size:13px; display:block; margin-bottom:6px; }

    .row { display:flex; gap:8px; align-items:center; }
    .btn { background:var(--accent); color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn.secondary { background:#fff; color:var(--accent); border:1px solid var(--border); }
    .btn.small { padding:6px 10px; font-size:12px; }

    table { width:100%; border-collapse:collapse; margin-top:10px; }
    table th, table td { border:1px solid var(--border); padding:8px; text-align:center; font-size:13px; }
    table th { background:#fafafa; }

    .timer { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace; font-size:28px; text-align:center; margin-top:8px; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.32); display:flex; align-items:center; justify-content:center; z-index:200; }
    .modal { background:#fff; border-radius:12px; width:94%; max-width:560px; padding:14px; border:1px solid var(--border); box-shadow:var(--shadow); }
    .list { max-height:340px; overflow:auto; margin-top:8px; }
    .draggable { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-radius:8px; border:1px solid var(--border); margin-bottom:8px; background:#fff; }
    .handle { width:18px; height:18px; display:inline-block; background:linear-gradient(90deg,#ddd,#f6f6f6); border-radius:3px; margin-right:8px; }

    /* chart canvas */
    .chart-wrap { max-width:720px; margin:0 auto; border-radius:10px; overflow:hidden; background:#fff; border:1px solid var(--border); padding:12px; }
    canvas { display:block; width:100%; height:240px; }

    /* small helpers */
    .muted { color:var(--muted); font-size:13px; }
    .small { font-size:13px; color:var(--muted); }
    .session-card { margin-bottom:16px; }
    .session-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .exercise-block { margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
    .series-item { display:flex; justify-content:space-between; padding:4px 0; font-size:13px; }

    @media(min-width:720px){
      main { padding:20px; }
      .card { max-width:640px; }
    }
  </style>
</head>
<body>
  <header><h1>Gym Tracker</h1></header>

  <main>
    <!-- Ejercicios -->
    <section id="ejercicios" class="active" aria-label="Mis ejercicios">
      <h2>Mis Ejercicios</h2>
      <div id="lista-ejercicios" aria-live="polite"></div>
      <button class="fab" id="fab-nuevo-ejercicio" title="Nuevo ejercicio" aria-label="Nuevo ejercicio">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </section>

    <!-- Rutinas -->
    <section id="rutinas" aria-label="Mis rutinas">
      <h2>Mis Rutinas</h2>
      <div id="lista-rutinas" aria-live="polite"></div>
      <button class="fab" id="fab-nueva-rutina" title="Nueva rutina" style="right:18px" aria-label="Nueva rutina">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
    </section>

    <!-- Entrenamiento -->
    <section id="entrenamiento" aria-label="Entrenamiento activo">
      <h2>Entrenamiento Activo</h2>
      
      <div class="card" style="flex-direction:column;align-items:stretch;">
        <div class="session-header">
          <div>
            <label class="muted">Sesión actual</label>
            <div style="font-weight:600;" id="sesion-actual-info">Hoy</div>
          </div>
          <button class="btn small secondary" id="btn-nueva-sesion">Nueva Sesión</button>
        </div>

        <div style="margin-top:10px;">
          <label class="muted">Ejercicio actual</label>
          <select id="select-ejercicio" class="input" aria-label="Seleccionar ejercicio"></select>
        </div>

        <div class="row" style="margin-top:10px;">
          <div style="flex:1;">
            <label class="muted">Peso (kg)</label>
            <input id="peso" type="number" class="input" />
          </div>
          <div style="width:110px;">
            <label class="muted">Reps</label>
            <input id="reps" type="number" class="input" />
          </div>
          <div style="width:120px;display:flex;flex-direction:column;gap:8px;">
            <label class="muted">Descanso (seg)</label>
            <input id="input-temporizador-seg" class="input" type="number" min="5" step="5" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;">
          <button class="btn" id="btn-guardar-serie">Añadir Serie</button>
          <button class="btn secondary" id="btn-iniciar-temporizador">Iniciar</button>
          <button class="btn secondary" id="btn-detener-temporizador">Detener</button>
        </div>

        <div style="margin-top:12px;">
          <div class="muted" style="margin-bottom:6px;">Series de hoy:</div>
          <div id="series-hoy"></div>
        </div>

        <div class="timer" id="temporizador">00:00</div>
      </div>
    </section>

    <!-- Progreso -->
    <section id="progreso" aria-label="Progreso">
      <h2>Progreso</h2>

      <div style="max-width:720px;margin:0 auto;">
        <label class="muted">Selecciona ejercicio</label>
        <select id="select-progreso" class="input" style="margin-bottom:10px;"></select>

        <div class="chart-wrap">
          <canvas id="graficaProgreso"></canvas>
        </div>

        <div style="margin-top:20px;">
          <h3 style="font-size:14px; margin-bottom:8px;">Historial por Sesiones</h3>
          <div id="historial-sesiones"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- nav -->
  <nav aria-label="Navegación">
    <button id="nav-ejercicios" data-section="ejercicios" class="active" title="Ejercicios">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      <span>Ejercicios</span>
    </button>
    <button id="nav-rutinas" data-section="rutinas" title="Rutinas">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.6"/></svg>
      <span>Rutinas</span>
    </button>
    <button id="nav-entrenamiento" data-section="entrenamiento" title="Entreno">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v20M5 7h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      <span>Entreno</span>
    </button>
    <button id="nav-progreso" data-section="progreso" title="Progreso">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 17h4v-7H3v7zm6 0h4v-11h-4v11zm6 0h4v-4h-4v4z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
      <span>Progreso</span>
    </button>
  </nav>

  <!-- modal container -->
  <div id="modal-container" style="display:none;"></div>

<script>
/* ============================
  Nueva Estructura de Datos - SESIONES
============================ */
let ejercicios = JSON.parse(localStorage.getItem('ejercicios')) || ["Sentadilla con Barra", "Press de Banca", "Peso Muerto"];
let rutinas = JSON.parse(localStorage.getItem('rutinas')) || [];
let sesiones = JSON.parse(localStorage.getItem('sesiones')) || [];
let temporizadorDefault = parseInt(localStorage.getItem('temporizadorDefault')) || 90;
let temporizadorState = JSON.parse(localStorage.getItem('temporizadorState')) || { running:false, restante: temporizadorDefault, lastTick:null };
let sesionActivaId = localStorage.getItem('sesionActivaId') || null;

function saveAll(){
  localStorage.setItem('ejercicios', JSON.stringify(ejercicios));
  localStorage.setItem('rutinas', JSON.stringify(rutinas));
  localStorage.setItem('sesiones', JSON.stringify(sesiones));
  localStorage.setItem('temporizadorDefault', String(temporizadorDefault));
  localStorage.setItem('temporizadorState', JSON.stringify(temporizadorState));
  localStorage.setItem('sesionActivaId', sesionActivaId);
}

/* ============================
  Gestión de Sesiones
============================*/
function crearNuevaSesion(){
  const hoy = new Date().toISOString().split('T')[0];
  const nuevaSesion = {
    id: 'sesion_' + Date.now(),
    fecha: hoy,
    nombre: `Entrenamiento ${hoy}`,
    ejercicios: {}
  };
  sesiones.unshift(nuevaSesion);
  sesionActivaId = nuevaSesion.id;
  saveAll();
  return nuevaSesion;
}

function obtenerSesionActiva(){
  if (!sesionActivaId) {
    return crearNuevaSesion();
  }
  
  const sesion = sesiones.find(s => s.id === sesionActivaId);
  if (!sesion) {
    return crearNuevaSesion();
  }
  
  // Verificar si la sesión activa es de hoy
  const hoy = new Date().toISOString().split('T')[0];
  if (sesion.fecha !== hoy) {
    // Si no es de hoy, crear nueva sesión
    return crearNuevaSesion();
  }
  
  return sesion;
}

function obtenerEjerciciosDeSesion(sesionId){
  const sesion = sesiones.find(s => s.id === sesionId);
  return sesion ? sesion.ejercicios : {};
}

function actualizarInfoSesion(){
  const sesion = obtenerSesionActiva();
  const infoEl = document.getElementById('sesion-actual-info');
  if (infoEl && sesion) {
    infoEl.textContent = sesion.nombre;
  }
}

/* ============================
  Utilidades
============================*/
function escapeHtml(text){
  if (!text) return '';
  return String(text).replace(/[&"'<>]/g, function (a) {
    return {'&':'&amp;','"':'&quot;',"'":"&#39;",'<':'&lt;','>':'&gt;'}[a];
  });
}
function fmtDateISOToLocal(iso){
  try {
    const d = new Date(iso);
    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  } catch(e){ return iso; }
}
function fmtDateShort(dateStr){
  try {
    const d = new Date(dateStr + 'T00:00:00');
    return d.toLocaleDateString();
  } catch(e){ return dateStr; }
}

/* ============================
  Navegación
============================*/
function showSection(id){
  document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
  const target = document.getElementById(id);
  if (target) target.classList.add('active');

  document.querySelectorAll('nav button').forEach(b=> b.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>{ if (b.dataset.section === id) b.classList.add('active'); });

  if (id === 'ejercicios') renderEjercicios();
  if (id === 'rutinas') renderRutinas();
  if (id === 'entrenamiento') {
    renderEjercicios();
    actualizarInfoSesion();
    renderSeriesHoy();
  }
  if (id === 'progreso') {
    renderSelectProgreso();
    drawProgressChart();
    renderHistorialSesiones();
  }
}

/* ============================
  Ejercicios
============================*/
function renderEjercicios(){
  const cont = document.getElementById('lista-ejercicios');
  cont.innerHTML = '';
  if (ejercicios.length === 0){
    const ph = document.createElement('div');
    ph.className = 'card';
    ph.innerHTML = '<div class="muted">No hay ejercicios. Pulsa + para crear uno.</div>';
    cont.appendChild(ph);
    return;
  }

  ejercicios.forEach((e,i)=>{
    const card = document.createElement('div'); card.className='card';
    const left = document.createElement('div'); left.className='left';
    left.innerHTML = `<strong>${escapeHtml(e)}</strong><div class="muted">Ejercicio #${i+1}</div>`;
    const actions = document.createElement('div');
    actions.style.display='flex'; actions.style.gap='6px';
    const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.title='Editar';
    editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 21l3.9-.9L20.7 6.3a1 1 0 0 0 0-1.4L19.1 3.3a1 1 0 0 0-1.4 0L4.5 16.5 3 21z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    editBtn.addEventListener('click', ()=> openExerciseModal(i));
    const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='Borrar';
    delBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v14m8-14v14" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>`;
    delBtn.addEventListener('click', ()=>{
      if (!confirm(`¿Eliminar ejercicio "${ejercicios[i]}"?`)) return;
      const removed = ejercicios.splice(i,1)[0];
      // eliminar de rutinas
      rutinas = rutinas.map(r=> ({...r, ejercicios: r.ejercicios.filter(x=>x!==removed)}));
      // eliminar de sesiones
      sesiones.forEach(s => {
        if (s.ejercicios[removed]) {
          delete s.ejercicios[removed];
        }
      });
      saveAll();
      renderEjercicios(); renderRutinas(); renderSelectProgreso(); drawProgressChart();
    });
    actions.appendChild(editBtn); actions.appendChild(delBtn);
    card.appendChild(left); card.appendChild(actions);
    cont.appendChild(card);
  });

  fillExerciseSelect();
}

function openExerciseModal(index){
  const container = document.getElementById('modal-container'); container.innerHTML=''; container.style.display='block';
  const backdrop = document.createElement('div'); backdrop.className='modal-backdrop';
  const modal = document.createElement('div'); modal.className='modal';
  modal.innerHTML = `
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <strong>${index==null ? 'Nuevo ejercicio' : 'Editar ejercicio'}</strong>
      <button id="close" class="icon-btn" title="Cerrar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></button>
    </header>
    <div style="margin-top:10px;">
      <label class="muted">Nombre</label>
      <input id="nombre-ej" class="input" value="${index!=null ? escapeHtml(ejercicios[index]) : ''}" />
    </div>
    <div style="margin-top:12px;text-align:right;">
      <button id="cancel" class="btn secondary">Cancelar</button>
      <button id="save" class="btn">Guardar</button>
    </div>
  `;
  backdrop.appendChild(modal); container.appendChild(backdrop);

  modal.querySelector('#close').addEventListener('click', close);
  modal.querySelector('#cancel').addEventListener('click', close);
  modal.querySelector('#save').addEventListener('click', ()=>{
    const val = modal.querySelector('#nombre-ej').value && modal.querySelector('#nombre-ej').value.trim();
    if (!val){ alert('Escribe un nombre'); return; }
    if (index==null){
      ejercicios.push(val);
    } else {
      const old = ejercicios[index];
      ejercicios[index] = val;
      // actualizar rutinas que contenían el nombre antiguo
      rutinas = rutinas.map(r=> ({...r, ejercicios: r.ejercicios.map(x=> x===old ? val : x)}));
      // actualizar sesiones
      sesiones.forEach(s => {
        if (s.ejercicios[old]) {
          s.ejercicios[val] = s.ejercicios[old];
          delete s.ejercicios[old];
        }
      });
    }
    saveAll();
    close();
    renderEjercicios(); renderRutinas(); renderSelectProgreso(); drawProgressChart();
  });

  function close(){ container.style.display='none'; container.innerHTML=''; }
}

/* ============================
  Rutinas
============================*/
function renderRutinas(){
  const cont = document.getElementById('lista-rutinas'); cont.innerHTML='';
  if (rutinas.length === 0){
    const ph = document.createElement('div'); ph.className='card'; ph.innerHTML = '<div class="muted">No hay rutinas. Pulsa + para crear una.</div>'; cont.appendChild(ph); return;
  }
  rutinas.forEach((r,i)=>{
    const card = document.createElement('div'); card.className='card';
    const left = document.createElement('div'); left.className='left'; left.innerHTML = `<strong>${escapeHtml(r.nombre)}</strong><div class="muted">${r.ejercicios.length} ejercicios</div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px';
    const loadBtn = document.createElement('button'); loadBtn.className='icon-btn'; loadBtn.title='Cargar rutina';
    loadBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M5 12h14M12 5v14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`;
    loadBtn.addEventListener('click', ()=> cargarRutina(i));
    const editBtn = document.createElement('button'); editBtn.className='icon-btn'; editBtn.title='Editar';
    editBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 21l3.9-.9L20.7 6.3a1 1 0 0 0 0-1.4L19.1 3.3a1 1 0 0 0-1.4 0L4.5 16.5 3 21z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    editBtn.addEventListener('click', ()=> openRutinaModal(i));
    const delBtn = document.createElement('button'); delBtn.className='icon-btn'; delBtn.title='Borrar';
    delBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M8 6v14m8-14v14" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>`;
    delBtn.addEventListener('click', ()=> { if (!confirm(`¿Eliminar rutina "${r.nombre}"?`)) return; rutinas.splice(i,1); saveAll(); renderRutinas(); });

    actions.appendChild(loadBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
    card.appendChild(left); card.appendChild(actions); cont.appendChild(card);
  });
}

function openRutinaModal(index){
  const container = document.getElementById('modal-container'); container.innerHTML=''; container.style.display='block';
  const backdrop = document.createElement('div'); backdrop.className='modal-backdrop';
  const modal = document.createElement('div'); modal.className='modal';
  const copy = index!=null ? JSON.parse(JSON.stringify(rutinas[index])) : {nombre:'', ejercicios:[]};
  modal.innerHTML = `
    <header style="display:flex;justify-content:space-between;align-items:center;">
      <strong>${index==null ? 'Nueva rutina' : 'Editar rutina'}</strong>
      <button id="close" class="icon-btn" title="Cerrar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></button>
    </header>
    <div style="margin-top:8px;">
      <label class="muted">Nombre</label>
      <input id="rutina-nombre" class="input" value="${escapeHtml(copy.nombre||'')}" />
    </div>
    <div style="margin-top:10px;">
      <strong class="small">Ejercicios (marca para incluir, arrastra para reordenar)</strong>
      <div class="list" id="rutina-list"></div>
    </div>
    <div style="margin-top:10px;text-align:right;">
      <button id="cancel" class="btn secondary">Cancelar</button>
      <button id="save" class="btn">Guardar</button>
    </div>
  `;
  backdrop.appendChild(modal); container.appendChild(backdrop);

  let order = [...(copy.ejercicios || [])];
  ejercicios.forEach(e => { if (!order.includes(e)) order.push(e); });

  function renderList(){
    const list = modal.querySelector('#rutina-list'); list.innerHTML='';
    order.forEach((name,idx)=>{
      const item = document.createElement('div'); item.className='draggable'; item.draggable=true; item.dataset.index = idx;
      const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';
      left.innerHTML = `<span class="handle" aria-hidden></span><input type="checkbox" ${ (copy.ejercicios||[]).includes(name) ? 'checked' : '' } data-name="${escapeHtml(name)}" id="chk-${idx}" /><label for="chk-${idx}" style="margin-left:8px;">${escapeHtml(name)}</label>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
      right.innerHTML = `<button class="icon-btn up" title="Subir"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 5l-7 7h14l-7-7z" stroke="currentColor" stroke-width="1.2"/></svg></button><button class="icon-btn down" title="Bajar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M12 19l7-7H5l7 7z" stroke="currentColor" stroke-width="1.2"/></svg></button>`;
      item.appendChild(left); item.appendChild(right);
      list.appendChild(item);

      item.addEventListener('dragstart', ev => { ev.dataTransfer.setData('text/plain', idx); item.style.opacity='0.5'; });
      item.addEventListener('dragend', ()=> item.style.opacity='1');
      item.addEventListener('dragover', ev => ev.preventDefault());
      item.addEventListener('drop', ev => {
        ev.preventDefault();
        const from = parseInt(ev.dataTransfer.getData('text/plain'),10);
        const to = parseInt(item.dataset.index,10);
        const moved = order.splice(from,1)[0];
        order.splice(to,0,moved);
        renderList();
      });

      right.querySelector('.up').addEventListener('click', ()=> {
        const i = idx; if (i<=0) return; [order[i-1],order[i]] = [order[i],order[i-1]]; renderList();
      });
      right.querySelector('.down').addEventListener('click', ()=> {
        const i = idx; if (i>=order.length-1) return; [order[i+1],order[i]] = [order[i],order[i+1]]; renderList();
      });

      left.querySelector('input[type=checkbox]').addEventListener('change', ev => {
        const n = name;
        if (ev.target.checked){
          if (!copy.ejercicios) copy.ejercicios = [];
          if (!copy.ejercicios.includes(n)) copy.ejercicios.push(n);
        } else {
          copy.ejercicios = (copy.ejercicios||[]).filter(x=>x!==n);
        }
      });
    });
  }
  renderList();

  modal.querySelector('#close').addEventListener('click', close);
  modal.querySelector('#cancel').addEventListener('click', close);
  modal.querySelector('#save').addEventListener('click', ()=>{
    const nombre = modal.querySelector('#rutina-nombre').value && modal.querySelector('#rutina-nombre').value.trim();
    if (!nombre){ alert('Pon un nombre a la rutina'); return; }
    const seleccion = order.filter(x => (copy.ejercicios||[]).includes(x));
    const nueva = { nombre, ejercicios: seleccion };
    if (index==null) rutinas.push(nueva); else rutinas[index] = nueva;
    saveAll();
    close();
    renderRutinas();
  });

  function close(){ container.style.display='none'; container.innerHTML=''; }
}

function nuevaRutina(){ if (ejercicios.length===0){ alert('Primero crea ejercicios.'); return; } openRutinaModal(null); }

function cargarRutina(i){
  const r = rutinas[i];
  if (!r || !r.ejercicios || r.ejercicios.length===0){ alert('La rutina no tiene ejercicios.'); return; }
  const select = document.getElementById('select-ejercicio'); select.innerHTML='';
  r.ejercicios.forEach(e => { const opt = document.createElement('option'); opt.value = e; opt.textContent = e; select.appendChild(opt); });
  showSection('entrenamiento');
}

/* ============================
  Entrenamiento / Registros por Sesión
============================*/
function fillExerciseSelect(){
  const select = document.getElementById('select-ejercicio');
  if (!select) return;
  const prev = select.value;
  select.innerHTML = '';
  ejercicios.forEach(e => { const opt = document.createElement('option'); opt.value = e; opt.textContent = e; select.appendChild(opt); });
  if (prev) select.value = prev;
}

function guardarSerie(){
  const select = document.getElementById('select-ejercicio');
  const ejercicio = select ? select.value : null;
  const pesoVal = document.getElementById('peso').value;
  const repsVal = document.getElementById('reps').value;
  if (!ejercicio){ alert('Selecciona un ejercicio.'); return; }
  if (!pesoVal || !repsVal){ alert('Introduce peso y repeticiones.'); return; }
  const peso = parseFloat(pesoVal);
  const reps = parseInt(repsVal,10);
  const fechaISO = new Date().toISOString();

  const sesion = obtenerSesionActiva();
  
  // Inicializar array para este ejercicio si no existe
  if (!sesion.ejercicios[ejercicio]) {
    sesion.ejercicios[ejercicio] = [];
  }

  // Evitar duplicados: si la última serie tiene mismo peso/reps en los últimos 10 segundos
  const seriesEjercicio = sesion.ejercicios[ejercicio];
  if (seriesEjercicio.length > 0) {
    const last = seriesEjercicio[seriesEjercicio.length-1];
    if (last.peso === peso && last.reps === reps) {
      const diffSec = (new Date(fechaISO) - new Date(last.fechaISO)) / 1000;
      if (diffSec < 10){
        alert('Serie similar registrada hace pocos segundos. Evitado duplicado.');
        return;
      }
    }
  }

  // Añadir nueva serie
  seriesEjercicio.push({ peso, reps, fechaISO });
  
  saveAll();
  renderSeriesHoy();

  const btn = document.getElementById('btn-guardar-serie'); btn.textContent = '✓ Añadido';
  setTimeout(()=> btn.textContent = 'Añadir Serie', 900);
}

function renderSeriesHoy(){
  const cont = document.getElementById('series-hoy');
  const sesion = obtenerSesionActiva();
  
  if (!sesion || Object.keys(sesion.ejercicios).length === 0) {
    cont.innerHTML = '<div class="muted">No hay series registradas hoy</div>';
    return;
  }

  let html = '';
  Object.entries(sesion.ejercicios).forEach(([ejercicio, series]) => {
    if (series.length > 0) {
      html += `<div class="exercise-block">`;
      html += `<div style="font-weight:600; margin-bottom:4px;">${escapeHtml(ejercicio)}</div>`;
      series.forEach(serie => {
        html += `<div class="series-item">`;
        html += `<span>${serie.peso}kg × ${serie.reps} reps</span>`;
        html += `<span class="muted">${new Date(serie.fechaISO).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>`;
        html += `</div>`;
      });
      html += `</div>`;
    }
  });
  
  cont.innerHTML = html;
}

function nuevaSesion(){
  if (confirm('¿Crear nueva sesión de entrenamiento? Se perderá la sesión actual no guardada.')) {
    crearNuevaSesion();
    actualizarInfoSesion();
    renderSeriesHoy();
  }
}

/* ============================
  Temporizador persistente
============================*/
let temporizadorInterval = null;

function actualizarTemporizadorUI(){
  const el = document.getElementById('temporizador');
  const restante = temporizadorState.restante ?? temporizadorDefault;
  const mins = String(Math.floor(restante/60)).padStart(2,'0');
  const secs = String(restante%60).padStart(2,'0');
  el.textContent = `${mins}:${secs}`;
  const input = document.getElementById('input-temporizador-seg');
  if (input && !temporizadorState.running) input.value = temporizadorDefault;
}

function iniciarTemporizador(segundos=null){
  if (segundos==null) segundos = parseInt(document.getElementById('input-temporizador-seg').value || temporizadorDefault,10);
  if (!segundos || segundos <=0) segundos = temporizadorDefault;
  temporizadorDefault = segundos;
  temporizadorState.restante = segundos;
  temporizadorState.running = true;
  temporizadorState.lastTick = Date.now();
  saveAll();
  clearInterval(temporizadorInterval);
  temporizadorInterval = setInterval(()=> {
    const now = Date.now();
    const diff = Math.round((now - (temporizadorState.lastTick||now))/1000);
    if (diff >= 1){
      temporizadorState.restante = Math.max(0, temporizadorState.restante - diff);
      temporizadorState.lastTick = now;
      if (temporizadorState.restante <= 0){
        temporizadorState.running = false;
        clearInterval(temporizadorInterval);
        try { if (navigator.vibrate) navigator.vibrate([200,80,200]); } catch(e) {}
        alert('¡Descanso terminado!');
      }
      actualizarTemporizadorUI();
      saveAll();
    }
  }, 700);
  actualizarTemporizadorUI();
}

function detenerTemporizador(){
  temporizadorState.running = false;
  temporizadorState.lastTick = null;
  clearInterval(temporizadorInterval);
  saveAll();
  actualizarTemporizadorUI();
}

function restoreTemporizadorOnLoad(){
  if (temporizadorState.running && temporizadorState.lastTick){
    const now = Date.now();
    const elapsed = Math.round((now - temporizadorState.lastTick)/1000);
    temporizadorState.restante = Math.max(0, (temporizadorState.restante||temporizadorDefault) - elapsed);
    if (temporizadorState.restante <= 0){ temporizadorState.running = false; temporizadorState.restante = temporizadorDefault; temporizadorState.lastTick = null; saveAll(); actualizarTemporizadorUI(); }
    else iniciarTemporizador();
  } else {
    temporizadorState.restante = temporizadorState.restante ?? temporizadorDefault;
    actualizarTemporizadorUI();
  }
}

/* ============================
  Gráfica y Progreso
============================*/
const canvas = document.getElementById('graficaProgreso');
const ctx = canvas.getContext('2d');

function resizeCanvasToDisplaySize() {
  const ratio = window.devicePixelRatio || 1;
  const width = canvas.clientWidth;
  const height = canvas.clientHeight;
  if (canvas.width !== Math.round(width * ratio) || canvas.height !== Math.round(height * ratio)) {
    canvas.width = Math.round(width * ratio);
    canvas.height = Math.round(height * ratio);
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
  }
}

function obtenerTodasLasSeriesDeEjercicio(ejercicio){
  const todasLasSeries = [];
  sesiones.forEach(sesion => {
    if (sesion.ejercicios[ejercicio]) {
      sesion.ejercicios[ejercicio].forEach(serie => {
        todasLasSeries.push({
          ...serie,
          sesionId: sesion.id,
          sesionFecha: sesion.fecha
        });
      });
    }
  });
  return todasLasSeries.sort((a,b) => new Date(a.fechaISO) - new Date(b.fechaISO));
}

function drawProgressChart(){
  resizeCanvasToDisplaySize();
  const select = document.getElementById('select-progreso');
  const ejercicio = select ? select.value : (ejercicios[0] || '');
  const todasLasSeries = obtenerTodasLasSeriesDeEjercicio(ejercicio);

  // clear
  ctx.clearRect(0,0,canvas.width, canvas.height);

  // placeholder if no datos
  if (!todasLasSeries.length){
    ctx.fillStyle = '#f8f8f8';
    ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
    ctx.fillStyle = '#666'; ctx.font = '14px system-ui';
    ctx.textAlign='center'; ctx.fillText('No hay datos para este ejercicio', canvas.clientWidth/2, canvas.clientHeight/2);
    return;
  }

  // compute arrays
  const fechas = todasLasSeries.map(d => new Date(d.fechaISO).getTime());
  const pesos = todasLasSeries.map(d => d.peso);
  const volumenes = todasLasSeries.map(d => d.peso * d.reps);

  // dimensions and padding
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  const paddingLeft = 48;
  const paddingRight = 16;
  const paddingTop = 18;
  const paddingBottom = 36;

  // scales extents
  const minFecha = Math.min(...fechas);
  const maxFecha = Math.max(...fechas);
  const minPeso = Math.min(...pesos) * 0.98;
  const maxPeso = Math.max(...pesos) * 1.02;
  const maxVol = Math.max(...volumenes);

  const usableW = W - paddingLeft - paddingRight;
  const usableH = H - paddingTop - paddingBottom;

  function xFor(ts){
    if (maxFecha === minFecha) return paddingLeft + usableW/2;
    return paddingLeft + ((ts - minFecha)/(maxFecha - minFecha)) * usableW;
  }
  function yForPeso(p){
    if (maxPeso === minPeso) return paddingTop + usableH/2;
    const frac = (p - minPeso) / (maxPeso - minPeso);
    return paddingTop + (1 - frac) * usableH;
  }
  function yForVol(v){
    if (maxVol === 0) return paddingTop + usableH;
    const frac = v / maxVol;
    return paddingTop + (1 - frac) * usableH;
  }

  // background / grid
  ctx.fillStyle = '#fff';
  ctx.fillRect(0,0,W,H);

  // horizontal grid lines for weight (4 lines)
  ctx.strokeStyle = '#f0f0f0';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for (let i=0;i<=4;i++){
    const y = paddingTop + (i/4)*usableH;
    ctx.moveTo(paddingLeft, y);
    ctx.lineTo(W - paddingRight, y);
  }
  ctx.stroke();

  // axes
  ctx.strokeStyle = '#e6e6e6';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(paddingLeft, paddingTop);
  ctx.lineTo(paddingLeft, paddingTop + usableH);
  ctx.lineTo(W - paddingRight, paddingTop + usableH);
  ctx.stroke();

  // draw volume bars
  const barWidth = Math.min(28, Math.max(10, usableW / fechas.length * 0.6));
  ctx.fillStyle = '#d0d0d0';
  fechas.forEach((ts, i) => {
    const x = xFor(ts) - barWidth/2;
    const yTop = yForVol(volumenes[i]);
    const h = (paddingTop + usableH) - yTop;
    ctx.fillRect(x, yTop, barWidth, h);
  });

  // draw line for weight
  ctx.beginPath();
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#111';
  fechas.forEach((ts,i)=>{
    const x = xFor(ts);
    const y = yForPeso(pesos[i]);
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // draw points
  ctx.fillStyle = '#111';
  fechas.forEach((ts,i)=>{
    const x = xFor(ts);
    const y = yForPeso(pesos[i]);
    ctx.beginPath();
    ctx.arc(x,y,3,0,Math.PI*2);
    ctx.fill();
  });

  // x labels (dates)
  ctx.fillStyle = '#666';
  ctx.font = '12px system-ui';
  ctx.textAlign = 'center';
  const labelCount = Math.min(6, fechas.length);
  for (let i=0;i<fechas.length;i++){
    const ts = fechas[i];
    const x = xFor(ts);
    if (fechas.length > labelCount && (i % Math.ceil(fechas.length/labelCount) !== 0)) continue;
    const d = new Date(ts);
    const text = `${d.getDate()}/${d.getMonth()+1}`;
    ctx.fillText(text, x, H - 12);
  }

  // left y labels for weight (min, mid, max)
  ctx.textAlign = 'right';
  ctx.font = '12px monospace';
  ctx.fillStyle = '#666';
  const yvals = [minPeso, (minPeso+maxPeso)/2, maxPeso];
  yvals.forEach(v=>{
    const y = yForPeso(v);
    ctx.fillText(Number(v).toFixed(1), paddingLeft - 8, y + 4);
  });

  // legend top-left
  ctx.fillStyle = '#111'; ctx.font = '12px system-ui'; ctx.textAlign='left';
  ctx.fillText('Peso (kg)', paddingLeft, paddingTop - 6);
  ctx.fillStyle = '#666';
  ctx.fillText('Volumen', paddingLeft + 100, paddingTop - 6);
}

function renderHistorialSesiones(){
  const cont = document.getElementById('historial-sesiones');
  cont.innerHTML = '';

  if (sesiones.length === 0) {
    cont.innerHTML = '<div class="muted">No hay sesiones registradas</div>';
    return;
  }

  sesiones.forEach(sesion => {
    const sessionCard = document.createElement('div');
    sessionCard.className = 'session-card card';
    
    let html = `<div class="session-header">`;
    html += `<div><strong>${sesion.nombre}</strong><div class="muted">${fmtDateShort(sesion.fecha)}</div></div>`;
    html += `<div class="muted">${Object.keys(sesion.ejercicios).length} ejercicios</div>`;
    html += `</div>`;
    
    Object.entries(sesion.ejercicios).forEach(([ejercicio, series]) => {
      if (series.length > 0) {
        const mejorPeso = Math.max(...series.map(s => s.peso));
        const mejorVolumen = Math.max(...series.map(s => s.peso * s.reps));
        
        html += `<div class="exercise-block">`;
        html += `<div style="font-weight:600;">${escapeHtml(ejercicio)}</div>`;
        html += `<div class="small" style="margin-top:4px;">`;
        html += `<span>Mejor: ${mejorPeso}kg</span>`;
        html += `<span style="margin-left:12px;">Volumen: ${mejorVolumen}kg</span>`;
        html += `<span style="margin-left:12px;">Series: ${series.length}</span>`;
        html += `</div>`;
        html += `</div>`;
      }
    });
    
    sessionCard.innerHTML = html;
    cont.appendChild(sessionCard);
  });
}

/* ============================
  Wiring: eventos iniciales
============================*/
document.addEventListener('DOMContentLoaded', ()=>{
  // nav
  document.querySelectorAll('nav button').forEach(b=>{
    b.addEventListener('click', ()=> showSection(b.dataset.section));
  });

  // fab
  document.getElementById('fab-nuevo-ejercicio').addEventListener('click', ()=> openExerciseModal(null));
  document.getElementById('fab-nueva-rutina').addEventListener('click', ()=> openRutinaModal(null));

  // entrenamiento listeners
  document.getElementById('btn-guardar-serie').addEventListener('click', guardarSerie);
  document.getElementById('btn-iniciar-temporizador').addEventListener('click', ()=> iniciarTemporizador());
  document.getElementById('btn-detener-temporizador').addEventListener('click', detenerTemporizador);
  document.getElementById('btn-nueva-sesion').addEventListener('click', nuevaSesion);

  const inputTemp = document.getElementById('input-temporizador-seg');
  inputTemp.value = temporizadorDefault;
  inputTemp.addEventListener('change', ()=>{
    const v = parseInt(inputTemp.value,10);
    if (isNaN(v) || v < 5) { inputTemp.value = temporizadorDefault; return; }
    temporizadorDefault = v;
    temporizadorState.restante = v;
    temporizadorState.running = false;
    saveAll();
    actualizarTemporizadorUI();
  });

  // progreso select
  document.getElementById('select-progreso').addEventListener('change', ()=> {
    drawProgressChart();
    renderHistorialSesiones();
  });

  // window resize -> redraw chart
  window.addEventListener('resize', ()=> drawProgressChart());

  // inicializar vistas
  renderEjercicios();
  renderRutinas();
  renderSeriesHoy();
  renderSelectProgreso();
  restoreTemporizadorOnLoad();
  renderHistorialSesiones();

  // default section
  showSection('ejercicios');
});

function renderSelectProgreso(){
  const sel = document.getElementById('select-progreso');
  if (!sel) return;
  const prev = sel.value;
  sel.innerHTML = '';
  const set = new Set(ejercicios);
  rutinas.forEach(r => (r.ejercicios||[]).forEach(e => set.add(e)));
  Array.from(set).forEach(e => {
    const opt = document.createElement('option'); opt.value = e; opt.textContent = e; sel.appendChild(opt);
  });
  if (prev) sel.value = prev;
  if (!sel.value && sel.options.length) sel.selectedIndex = 0;
}

/* Exponer algunas funciones en window para debugging/uso */
window.drawProgressChart = drawProgressChart;
window.openRutinaModal = openRutinaModal;
window.openExerciseModal = openExerciseModal;

</script>

<!-- Registro del Service Worker (PWA) -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('ServiceWorker registrado:', reg.scope))
      .catch(err => console.error('Error registrando ServiceWorker:', err));
  }
</script>

</body>
</html>
